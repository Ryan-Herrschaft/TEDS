---
title: "TEDS_Poster_Nebraska"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r, include= F}
#Clean Environment
rm(list = ls())
```

```{r, include=FALSE}
#Load Packages
library(tidyverse)
library(gtsummary)
library(gt)
```

```{r}
#Load in data. The source of this file is in  TEDS_Service_Focused
load(file = "/Users/ryanherrschaft/Documents/TEDS Code/Data/NE_admissions_cleaned.RData")

CBSA_regions <- read_csv(file ="/Users/ryanherrschaft/Documents/TEDS Code/Data/CBSA for r.csv") 

#Loading in admissions per CBSA, used for Figure X. Full explanation availiable at TEDS_Service_Focused Markdown.
admissions_per_CBSA <- NE_admissions_cleaned %>%   
  group_by(CBSA2010_trichot) %>% 
  count() %>%  
  rename(n_admissions_in_stat_area = n) #renames 'n' to a more intuitive name
 
```

 
Introduction:
Substance use service modality has been identified as a key factor in predicting successful substance use treatment. Previous authors have established the importance of having treatment that matches the needs of the person seekign or being involuntarily refered to services. Despite the importance of appriorpiate service modality, several factors rooted in the American health care system inhibit the abiltiy of patients to access the most appropriate care possible. 

This study drew on The Treatment Episode Data Set (TEDS), which tracks both admissions and discharges from substance use treatment facilities, to assess service modality utilization acorss Nebraska. Specifically, we examined how utilization of the six modaliteis of service tracked by TEDS in Nebraska varied across the state's Core Based Statistical Areas (CBSA).

We found that a much higher proportion of admissions  in micropolitian environements were serviced using a ambulatory non-intensive outpatient modality (61.93%), compared to the proportion of admissions in metropoltan (31.76%) and Outside CBSAâ€™s (41.9%). Further, 24 hour detox, free standing residential treatment centers are much less commonly utilized in micropolitan areas (5.9%) compared metropolitan (48.75%) and outside CBSA areas (39.51%). 

In order to rule out that these differences might be attributle to differnces in the types of services offered across the state of Nebraska, we then accessed the Substance Abuse and Mental Health Serivce Administration's Behavioral Health Treatment Facility Listings Dataset (SAMHSA BHTFL). ANalyses of this dataset revealed differences in the services offered by treatment facilities across the CBSA regions, including a lack of facilities offering inpatient and resedential services in outside CBSA regions relative to micropolitan and metropolitan areas.

This is an ongoing study, with current analyses testing how regional differnces in substance use across Nebraska (as accessed through TEDS) and geographical contraints posed by rurality in outside CBSA regions (as assessed trough BHTFL) might explain differences in treatment capabilities across the state. 

Further, in the course of examining the SAMHSA and TEDS dataset, we have identified key data collection deficiets that if recitfied would allow for a more complete accessment of the status of servcie access across Nebraska's varied regions.

UNderstanding the profile of substance use services can help clarify how trends in substance use treatment across the state. Adittionaly, as these data sources are updated on a yearly basis, ongoign examination in longitudinal trends of service access can eludicate how responses to the evolving situation are reflected in changess in service utilziation over time. 



## Admissions Across Service Settings
Here is my attmept to understand how service utilization differs across groups. 
```{r, include = F}
admissions_to_service_sites_by_CBSA <- NE_admissions_cleaned %>% 
  count(SERVICES, CBSA2010_trichot) %>% 
  rename(n_using_service_type = n ) %>% 
  left_join(admissions_per_CBSA, by = "CBSA2010_trichot") %>% 
  mutate(percent_of_admittees_in_stat_area_using_service_type = (n_using_service_type * 100 / n_admissions_in_stat_area) %>% round(2) ) %>% 
  mutate(CBSA2010_trichot_labels = paste0(CBSA2010_trichot, ", n = ", n_admissions_in_stat_area))

```

 
 
```{r, include = F}
ggplot(data = admissions_to_service_sites_by_CBSA, aes(x = fct_reorder(SERVICES, percent_of_admittees_in_stat_area_using_service_type), y = percent_of_admittees_in_stat_area_using_service_type)) + geom_point() +
  geom_segment(aes(x = SERVICES,
                   xend = SERVICES, 
                   y = 0,
                   yend = percent_of_admittees_in_stat_area_using_service_type)) +
 geom_text(aes(label = paste0(percent_of_admittees_in_stat_area_using_service_type, "%")), nudge_y = 22, size = 3) +
 ylim(0,100) + 
  facet_wrap(~ CBSA2010_trichot_labels) +
   labs(
     x = "Service Type",
     y = "Percent",
   title = "Service Utilization at Admission to NE Treatment \nCenters in 2017"
  ) +
  coord_flip() +
  theme_classic()
```

Setting up tables to analyze service utilization across CBSA and Drug Use
``` {r}
for_table <- NE_admissions_cleaned %>% 
  
  select(CBSA2010_trichot, SERVICES, SUB1) %>% 
  #recode Sub1 to have the desired other group
  mutate(SUB1_recoded = recode(SUB1, 
                            "Non-prescription methadone" = "Other",
                            "PCP" = "Other",
                           "Other hallucinogens" = "Other",
                            "Other amphetamines" = "Other",
                            "Other stimulants" = "Other",
                           "Other non-benzodiazepine tranquilizers" = "Other",
                            "Barbiturates" = "Other",
                            "Other non-barbiturate sedatives or hypnotics" = "Other",
                            "Inhalants" = "Other",
                            "Over-the-counter medications" = "Other",
                            "Missing/unknown/not collected/invalid"= "NA"),
         Services_recoded = recode(SERVICES,
                                  "Rehab/residential, short term (30 days or fewer)"   =  "Residential rehabilitation",
                                  "Rehab/residential, long term (30 days or more)" = "Residential rehabilitation",
                                  "Detox, 24-hour, free-standing residential" = "Residential rehabilitation",
                                  "Ambulatory, intensive outpatient" = "Outpatient",
                                  "Ambulatory, non-intensive outpatient" = "Outpatient",
                                  "Ambulatory, detoxification" = "Outpatient"
         )) %>% 
                           
  select(-SUB1) %>% 
  #remove NA
  filter(SUB1_recoded != "NA")

#drop NA as a factor so it does not show up in later tables. 
for_table$SUB1_recoded <- for_table$SUB1_recoded %>% droplevels()

```



Previous authors from SAMHSA have collapsed the eight service modalilties in this way: 


(source: https://www.samhsa.gov/data/sites/default/files/NSDUH-DR-Task2SubUseTx-2014/NSDUH-DR-Task2SubUseTx-2014.htm)
I will copy their lead on this to simplify reporting and interpretation. 

Vizualizing for service utilization across CBSA and Drug Use 
```{r}
 fig2<- for_table %>% ggplot( aes(x = CBSA2010_trichot, fill = SUB1_recoded)) +
  geom_bar() +
  facet_wrap( ~ SERVICES, nrow = 3) +
  coord_flip() +
  theme_classic() +
  labs( y = "Count",
        x = "CBSA Regions",
        title = "Admission Counts per Substance Across \nCBSA Regions and Service Types"
  )  



fig1 <- for_table %>% ggplot( aes(x = CBSA2010_trichot, fill = SERVICES)) +
  geom_bar() + 
  theme_classic() +
  labs( title = "s")

# Proportional Data
fig2 <- for_table %>% ggplot( aes(x = CBSA2010_trichot, fill = SERVICES)) +
  geom_bar(position = "fill") + 
  labs(title = "Proportion of Admissions Accessing Each Particular Service Type,\n Across the CBSA Regions") +
  theme_classic() +
  labs(y = "Proportion") 
         
fig3 <- for_table %>% ggplot( aes(x = CBSA2010_trichot, fill = SERVICES)) +
  geom_bar(position = "fill") +
  facet_wrap (~ SUB1_recoded, nrow = 3) +
  coord_flip() +
  theme_classic() +
  labs( y = "Proportion",
        x = "CBSA Regions",
        title = "Proportion of Services Usage by Primary Substance \nReported at Admission and CBSA Regions"
  )  

for_table$SUB1_recoded <- fct_relevel(for_table$SUB1_recoded, c("None", "Other", "Benzodiazepine","Heroin", "Cocaine/crack","Synthetic opioids", "Marijuana", "Methamphetamine" , "Alcohol") ) %>% fct_rev()

for_table$sub1_recoded_labeler <- for_table$SUB1_recoded %>% fct_recode( "Metham-\nphetamine" ="Methamphetamine", "Cocaine/\ncrack" = "Cocaine/crack", "Benzo-\ndiazepine" = "Benzodiazepine")



Hmisc::label(for_table$Services_recoded) <- "Services"
(fig3_simplified <- for_table %>% 
  ggplot(aes (fill = Services_recoded, x = 1 )) +
  geom_bar(position = "fill") +
  facet_grid(rows = vars(CBSA2010_trichot), cols = vars(sub1_recoded_labeler),
             labeller = label_wrap_gen(width = 10),
             margins = TRUE
             ) +
  theme_classic() + 
  theme(
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_grey() +
  labs(
     y = "Proportion of Admittees \nUsing Service",
     fill = "Services",
       title = "Service Utilization Across Primary Substance Reported at Admission and \nCBSA Regions"
  ) ) 

```
Observations: 

resedential treatment is more common in metro and outside regions, compared to micropolitan ones

residential alcohol treatmetn is much more common in metro regions than it is in micro regions

residential methamphetamine treatmetn is much more common in metro regions than in micro regions

Marijuana treatmetn seems to be mostly outpatient, across all groups.

Synthetic opiods seems to be mostly outpatient across the board. A slight decrease in residential rehab in outside regions.

Outside regions rely much more on inpatient cocaine/crack treatment than micro and metro regions.

Outside regions rely much more on resedential treatment than micro or metro regions for treeatming heroin.

Outside regions rely much more on residential treatment for benzodiaxepine treatment than micro regions. 


Summary: Outside CBSA regions rely much more on residential ttreatment for cocaine/crack, heroin, and benzodiazepine treatment than micropolitan regions. Synthetic opiods treatment seems to be treated by outpaitenacross the board, but there is a slight decrease in residential treatment in outside CBSA regions. Residential treatment for methamphetamine  and alcohol are much more common in metropolitan regions than it is in micro ones.





# Import data on services in the state of Nebraska.
```{r}
BHTFL_raw <- readxl::read_xlsx(path = "/Users/ryanherrschaft/Downloads/Behavioral_Health_Treament_Facility_listing_2020_09_22_151049.xlsx", sheet = 1 )

BHTFL_codes <- readxl::read_xlsx(path = "/Users/ryanherrschaft/Downloads/Behavioral_Health_Treament_Facility_listing_2020_09_22_151049.xlsx", sheet = 2) %>% mutate(service_code = str_to_lower(service_code))   %>%  filter()

BHTFL_long <- BHTFL_raw %>% 
  #select cols of interest
  select(name1, county, type_facility, hi:rd, mc:ss, tele, shc:ssa, cmhc:rtcc, psyh:noop) %>%
  #generating a unique id is essential to pivot without error.
  mutate(id = row_number(), .before = name1
         ) %>% 
  pivot_longer(cols = hi:noop, names_to = "service") %>% 
  #replace na's with zeros to create indicator variables.
  mutate(value = replace_na(value, 0),
         value = factor(value, levels = c(0,1), labels = c("Service not offered", "Service offered")),
        county = factor(county),
         service = factor(service)
         )

#Adding CBSA data
BHTFL_long <- BHTFL_long %>% 
  left_join(CBSA_regions, by = c("county" = "CTYNAME")) %>% 
  mutate(
    CBSA = replace_na(CBSA, "Outside CBSA"), .after = id,
    CBSA = recode(CBSA, 
                  "Metropolitan" = "Metro",
                  "Micropolitan" = "Micro"
      
    )
         ) 




BHTFL_clean <- BHTFL_long %>% 
                  pivot_wider(names_from = service, values_from = value) 

Hmisc::label(BHTFL_clean$hi) <- "Hospital inpatient"
Hmisc::label(BHTFL_clean$op) <- "Outpatient"
Hmisc::label(BHTFL_clean$phdt) <- "Partial hospitalization/day treatment"
Hmisc::label(BHTFL_clean$res) <- "Residential"
Hmisc::label(BHTFL_clean$rs) <- "Short-term residential"
Hmisc::label(BHTFL_clean$rl) <- "Long-term residential"
Hmisc::label(BHTFL_clean$rd) <- "Residential detoxification"
```




Attach service with service description.
```{r}
joined <- BHTFL_long %>% left_join(BHTFL_codes, by = c("service" = "service_code")) %>% filter(sa_code == "Y") %>% 
  select(id, name1, county, CBSA, -type_facility, service, value, service_name, service_description, category_name, sa_code)  %>% 
  mutate(
    service_name = factor(service_name),
    category_name = factor(category_name)
  )

list_of_options <- paste("'", as.character(levels(joined$service_name)),"'", collapse = ", ", sep ="")


service_input <- "Accepts clients on opioid medication but prescribed elsewhere"
  
  
 joined %>%  
filter(service_name == service_input) %>% 
ggplot(aes(x= CBSA, fill = value )) + 
  geom_bar() + facet_wrap( ~ service_name,
                          labeller = label_wrap_gen()
                          ) +
  theme_classic()
       
       
       
  joined %>% select()
tbl_summary(joined)

levels(joined$category_name)

```



```{r}
 
retrieve_names <- function(data, cat_name_input) {
  
intermed <- data %>%
  filter(category_name == cat_name_input)

droplevels(intermed$service_name) %>% 
  levels()
}

retrieve_names(joined, "Screening & Testing")


levels(joined$category_name)
list_of_options <- paste("'", as.character(levels(joined$service_name)),"'", collapse = ", ", sep ="")



plot_function <- function(data = joined, input_spec) {
  
  data %>% 
filter(service_name == input$input_spec) %>% 
ggplot(aes(x= CBSA, fill = value )) + 
  geom_bar(position = "fill") +
  theme_classic() +
        labs(
         title = paste("Proportion of facilities offering", input$input_spec, "across CBSA"),
         x = "CBSA Regions",
         y = "Proportion"
        )
}


plot_function(input_spec = "Screening and Testing")

retr
retrieve_names(joined, "Service Settings (e.g., Outpatient, Residential, Inpatient, etc.)")

```


```{r}
library(shiny)

ui <- fluidPage(
  
  titlePanel("Visualzing Availibility of Screening Services Across Nebraskan CBSA Regions"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput(
        inputId = "screening_input",
        label = "Select the screening services you are interested in",
        choices  = retrieve_names(joined, "Screening & Testing")
        )
    ),
    mainPanel(
          tabsetPanel(type = "tabs",
                  tabPanel("Counts", plotOutput(outputId = "screening_count")),
                  tabPanel("Proportion", plotOutput(outputId = "screening_prop"))
          )
    )
  ),

titlePanel("Visualzing Availibility of Service Settings Across Nebraskan CBSA Regions"),

sidebarLayout(
    sidebarPanel(
      selectInput(
        inputId = "setting_input",
        label = "Select the service setting you are interested in",
        choices  = retrieve_names(joined, "Service Settings (e.g., Outpatient, Residential, Inpatient, etc.)")
        )
    ),
    mainPanel(
          tabsetPanel(type = "tabs",
                  tabPanel("Counts", plotOutput(outputId = "setting_count")),
                  tabPanel("Proportion", plotOutput("setting_prop"))
    )
  )
)
)



server <- function(input, output) {
  
  
output$screening_count <- renderPlot(
    {
joined %>% 
filter(service_name == input$screening_input) %>% 
ggplot(aes(x= CBSA, fill = value )) + 
  geom_bar() +
  theme_classic() +
        labs(
         title = paste("Count of facilities offering", input$screening_input, "across CBSA"),
         x = "CBSA Regions",
         y = "Count"
        )
    }
)

output$screening_prop <- renderPlot(
    {
joined %>% 
filter(service_name == input$screening_input) %>% 
ggplot(aes(x= CBSA, fill = value )) + 
  geom_bar(position = "fill") +
  theme_classic() +
        labs(
         title = paste("Proportion of facilities offering", input$screening_input, "across CBSA"),
         x = "CBSA Regions",
         y = "Proportion"
        ) +
    theme(
      legend.title = 'Service offerings'
    )
             
    }
)
}

shinyApp(ui = ui, server = server)

```


             



`
```




# Visualize data on the Services offered at substance use facilites across Nebraska.
```{r}
BHTFL_clean %>% 
  select(CBSA, hi:rd) %>% 
  tbl_summary(by = CBSA) %>% 
  as_gt() %>% 
  tab_header("Substance Use Service Settings Across CBSA Regions") %>% 
  tab_footnote("Percentages do not sum to 100% becasue each center may offer treatment in a multitude of settings", locations = cells_title()
               )
```



```{r}
library(ggmap)

register_google(key = "AIzaSyA1-_W8ZHHE7J8BOLbQwJN7ufUluixFsl4")
```

There are several important commands associated with ggmap. 


Entering the coordinates of an object or location are key to creating mappable data. A key importance: 
for longitude: locations east of the prime meridian are represented with positive numbers, locations west of the prime meridian are represented with negative longitudes. Latidudes north of the equator are positive numbers, while those south of the equator are negative.
```{r}
lincoln_coords <- c(lon = -96.7026, lat = 40.8136)

lincoln_coords
lincoln <- get_map(location = "the white house", zoom = 10, scale = 1, maptye = "roadmap")

test <- geocode(location = "Lincoln, NE")
ggmap(lincoln) +
  geom_point(x=-96.7026, y= 40.8136 )
```


```{r}
joined %>% group_by(category_name) 

 levels(joined$category_name)
```

